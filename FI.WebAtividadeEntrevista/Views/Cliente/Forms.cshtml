
<form id="formCadastro" method="post">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="Nome">Nome:</label>
                <input required="required" type="text" class="form-control" id="Nome" name="Nome" placeholder="Ex.: João" maxlength="50">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="Sobrenome">Sobrenome:</label>
                <input required="required" type="text" class="form-control" id="Sobrenome" name="Sobrenome" placeholder="Ex.: da Silva" maxlength="255">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="Cpf">CPF:</label>
                <input required="required" type="text" class="form-control" id="Cpf" name="Cpf" placeholder="Ex.: 010.011.111-00" maxlength="14">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="Nacionalidade">Nacionalidade:</label>
                <input required="required" type="text" class="form-control" id="Nacionalidade" name="Nacionalidade" placeholder="Ex.: brasileira" maxlength="50">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="CEP">CEP:</label>
                <input required="required" type="text" class="form-control" id="CEP" name="CEP" placeholder="Ex.: 01011-100" maxlength="9">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="Estado">Estado:</label>
                <select required="required" id="Estado" class="form-control" name="Estado">
                    <option value="">Selecione</option>
                    <option value="SP">São Paulo</option>
                    <option value="PE">Pernambuco</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="Cidade">Cidade:</label>
                <input required="required" type="text" class="form-control" id="Cidade" name="Cidade" maxlength="50" placeholder="Ex.: São Paulo">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label for="Logradouro">Logradouro:</label>
                <input required="required" type="text" class="form-control" id="Logradouro" name="Logradouro" placeholder="Ex.: Rua Boa Vista 253" maxlength="500">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="Email">E-mail:</label>
                <input required="required" type="text" class="form-control" id="Email" name="Email" placeholder="Ex.: email@email.com" maxlength="2079">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="Telefone">Telefone:</label>
                <input required="required" type="tel" class="form-control" id="Telefone" name="Telefone" placeholder="Ex.: (11) 2020-3030" maxlength="15">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="pull-left">
                <button id="btnBeneficiarios" type="button" class="btn btn-outline-dark" data-toggle="modal" data-target="#exampleModal">Beneficiários</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Beneficiários</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="CpfBeneficiario">CPF:</label>
                                <input type="text" class="form-control" id="CpfBeneficiario" name="CpfBeneficiario" maxlength="14">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="NomeBeneficiario">Nome:</label>
                                <input required="required" type="text" class="form-control" id="NomeBeneficiario" name="NomeBeneficiario" placeholder="Ex.: João da Silva" maxlength="50">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <a id="btnIncluir" class="btn btn-success">Incluir</a>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">CPF</th>
                                    <th scope="col">Nome</th>
                                    <th scope="col">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-lg-12">
            <div class="pull-right">
                <a id="btnSubmit" class="btn btn-sm btn-success">Salvar</a>
                @Html.ActionLink("Voltar", "Index", "Cliente", new { }, new { @class = "btn btn-sm btn-danger" })
            </div>
        </div>
    </div>
</form>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script src="http://digitalbush.com/files/jquery/maskedinput/rc3/jquery.maskedinput.js" type="text/javascript"></script>
<script type="text/javascript">
    jQuery(function ($) {
        $("#Cpf").mask("999.999.999-99");
        $("#CpfBeneficiario").mask("999.999.999-99");
    });

</script>

<script>

</script>

<script type="module">
    import { validarCPF } from '../../Scripts/ValidadorCpf.js';

    $('#btnSubmit').on('click', function () {
        let campoCPF = $('#Cpf').val();

        if (validarCPF(campoCPF) && VerificaExistenciaCPF(campoCPF) == false) {
            $('#formCadastro').submit();
        }
    })

    function VerificaExistenciaCPF(cpf) {
        $.ajax({
            url: '@Url.Action("VerificaCpfExistente", "Cliente")',
            method: "POST",
            data: {
                "cpf": cpf
            },
            error:
                function () {
                    return false;
                },
            success:
                function (response) {
                    if (response != null) {
                        alert('Cliente já cadastrado na base de dados.');
                        return response.usuarioEncontrado;
                    }
                }
        });
    }

    function VerificaExistenciaCPFBeneficiario(cpfBeneficiario) {
        $.ajax({
            url: '@Url.Action("VerificaCpfBeneficiarioExistente", "Cliente")',
            method: "POST",
            data: {
                "cpf": cpfBeneficiario
            },
            error:
                function () {
                    return false;
                },
            success:
                function (response) {
                    if (response != null) {
                        alert('Beneficiário já cadastrado na base de dados.');
                        return response.usuarioEncontrado;
                    }
                }
        });
    }

    $(document).ready(function () {

        // Denotes total number of rows
        var rowIdx = 0;

        // jQuery button click event to add a row
        $('#btnIncluir').on('click', function () {

            let campoCPFBeneficiario = $('#CpfBeneficiario').val();

            if (validarCPF(campoCPFBeneficiario) && VerificaExistenciaCPFBeneficiario(campoCPFBeneficiario) == false) {
                // Adding a row inside the tbody.
                $('#tbody').append(`<tr id="R${++rowIdx}">
                 <td class="row-index text-center">
                    <p>${$('#CpfBeneficiario').val()}</p>
                 </td>
                <td class="row-index text-center">
                    <p>${$('#NomeBeneficiario').val()}</p>
                 </td>
                  <td class="text-center">
                    <button class="btn btn-primary remove"
                      type="button">Excluir</button>
                    <button class="btn btn-primary change"
                      type="button">Alterar</button>
                    </td>
                  </tr>`);
            }
            else {
                alert('CPF Inválido');
            }
        });

        // jQuery button click event to remove a row.
        $('#tbody').on('click', '.remove', function () {

            // Getting all the rows next to the row
            // containing the clicked button
            var child = $(this).closest('tr').nextAll();

            // Iterating across all the rows
            // obtained to change the index
            child.each(function () {

                // Getting <tr> id.
                var id = $(this).attr('id');

                // Gets the row number from <tr> id.
                var dig = parseInt(id.substring(1));

                // Modifying row id.
                $(this).attr('id', `R${dig - 1}`);
            });

            // Removing the current row.
            $(this).closest('tr').remove();

            // Decreasing total number of rows by 1.
            rowIdx--;
        });

    });

</script>